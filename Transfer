import { useEffect, useState } from "react";
import ContainerCard from "./components/ContainerCard";
import { fetchContainers, fetchHistory } from "./services/api";

const REFRESH_INTERVAL = 60000; // 1 min

export default function App() {
  const [containers, setContainers] = useState([]);
  const [series, setSeries] = useState({});

  useEffect(() => {
    (async () => {
      const list = await fetchContainers();
      setContainers(list);

      // initial load
      const initialData = {};
      for (const cid of list) {
        initialData[cid] = await fetchHistory(cid);
      }
      setSeries(initialData);

      // polling every 1 min
      const interval = setInterval(async () => {
        const updated = {};
        for (const cid of list) {
          updated[cid] = await fetchHistory(cid);
        }
        setSeries(updated);
      }, REFRESH_INTERVAL);

      return () => clearInterval(interval);
    })();
  }, []);

  return (
    <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
      {containers.map((cid) => (
        <ContainerCard key={cid} name={cid} data={series[cid] ?? []} />
      ))}
    </div>
  );
}
